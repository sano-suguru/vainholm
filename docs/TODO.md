# TODO

## 実装優先度

### Phase A: プレミアムシステム拡張 ✅ (2026-01-18)

ハクスラ要素の核心。既存の武器プレミアムを拡張し、二層構造を導入。

- [x] 緑プレミアム（所持効果）の型定義追加 (`combat/types.ts`)
- [x] 緑プレミアム効果の実装（HP+、視界+、罠感知、忍び足）
- [x] 武器プレミアム調整：`かず+N`（攻撃回数）の追加
- [x] 武器プレミアム調整：`貫通`（敵貫通攻撃）の追加
- [x] ドロップ時の光色表示（白/青/緑/青緑/金）
- [x] 防具システムの基盤実装（防具タイプ、スロット）
- [x] 防具プレミアム（青）の実装（物理耐性、属性耐性、反射、棘）
- [x] 強化の巻物の実装（希少アイテム、プレミアム枠追加）
- [x] 装備画面（EquipmentScreen）の実装 - Brogue風統合ビュー
- [x] キーボードショートカット（E）で装備画面の開閉
- [x] Sidebar EQUIPMENTセクションのクリックで装備画面を開く
- [x] ホバー時の[E]ヒント表示
- [x] 武器/防具ドロップモーダルに「持ち物に入れる」オプション追加
- [x] ArmorDropModal（防具ドロップ時の比較・選択UI）の実装
- [x] インベントリへの武器/防具格納対応

### Phase B: 崩壊システム ✅ (2026-01-18)

片道勇者要素の核心。時間制約による緊張感を導入。

- [x] 崩壊状態の型定義追加 (`dungeon/types.ts`)
  - `COLLAPSE_CONSTANTS` (START_TICK: 200, TICKS_PER_FLOOR: 50)
  - `getCollapsedFloor()`, `getTurnsUntilCollapse()`, `isPlayerCaughtByCollapse()`
- [x] dungeonStoreに崩壊進行ロジック追加
  - `collapseEnabled` フラグ
  - `getCollapsedFloor()`, `getTurnsUntilCollapse()`, `isFloorCollapsed()`, `checkCollapseGameOver()`
- [x] 崩壊開始トリガー（200ターン後）
- [x] 崩壊速度設定（50ターン/1F）
- [x] 崩壊したフロアへのアクセス制限（`ascendStairs`で崩壊済みフロアへの移動をブロック）
- [x] 崩壊警告のHUD表示（TopBar：残りターン表示、urgencyレベル4段階）
- [x] 崩壊に巻き込まれた場合のゲームオーバー処理（`turnManager.ts`で毎ターンチェック）
- [x] カジュアルモード（崩壊なし）のUI追加（CharacterSelectionScreen：チェックボックスで切り替え）

### Phase C: パーティシステム

仲間による戦略性と装備分配のジレンマを導入。

- [ ] 仲間（Ally）の型定義（`combat/types.ts`に追加）
- [ ] gameStoreにパーティ状態追加（allies配列、最大3人）
- [ ] 仲間のAI行動モード（突撃/追従/待機）
- [ ] 仲間の描画（EnemyLayer相当のAllyLayer）
- [ ] 仲間への装備割り当てUI
- [ ] 仲間の死亡処理（永久ロスト、装備も消失）
- [ ] 仲間の味方化メカニクス（魔法or救出イベント）
- [ ] 仲間のHPバー表示
- [ ] 崩壊システムとの連携（仲間取り残しジレンマ）

### Phase D: 強化の巻物 + ユニーク装備

Brogue希少性と厳選の深みを導入。

- [ ] 強化の巻物のアイテム定義
- [ ] 強化の巻物使用UI
- [ ] プレミアム枠追加ロジック（ランダム付与）
- [ ] ユニーク装備の型定義（固定プレミアム、入手条件）
- [ ] ユニーク装備6種の定義（灰燼の剣、凍土の斧、貪食者の短剣、亡者の盾、千里眼のローブ、王の遺産）
- [ ] ボス固定ドロップの実装
- [ ] ユニーク入手イベントの実装

### Phase E: 創発的環境相互作用

Brogue創発性。要素の相互作用を実装。

- [ ] 地形相互作用システムの設計
- [ ] 火→草を燃やす→煙発生
- [ ] ガス+火→爆発
- [ ] 水→火を消す
- [ ] 沼→移動遅延
- [ ] 武器属性と地形の連携（火炎武器で草を燃やす等）
- [ ] 連鎖反応の処理順序

### Phase F: メタ進行拡張 + シード共有

リプレイ性と社会性を強化。

- [ ] 遺産ポイント計算ロジック
- [ ] 遺産ポイント表示UI（ラン終了時）
- [ ] クラス解放条件と処理
- [ ] 初期装備選択肢の拡張
- [ ] 倉庫枠拡張
- [ ] シード入力フィールドUI
- [ ] シード表示（現在のラン）
- [ ] シードコピー機能

---

## 既存タスク（武器システム） ✅

- [x] 装備中の武器情報をHUDに表示する（Sidebar EQUIPMENTセクション）
- [x] 任意のタイミングで武器を付け替える機能（装備画面から）
- [x] 武器管理ルールをGAME_DESIGN.mdに明記する

---

## 実装済み

- [x] 設計書をGAME_DESIGN.mdに統合（2026-01-18）
  - 設計哲学（Brogue/片道勇者/ハクスラ三つの柱）
  - 崩壊システム設計
  - パーティシステム設計
  - プレミアム二層構造（青/緑）
  - ユニーク装備セクション
  - メタ進行拡張（遺産ポイント）
  - シード共有システム
